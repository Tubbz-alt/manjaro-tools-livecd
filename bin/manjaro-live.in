#!/bin/sh

LIBDIR='@libdir@'
DATADIR='@datadir@'

livetimer=$(date +%s%3N)

[[ -r ${LIBDIR}/util-live.sh ]] && source ${LIBDIR}/util-live.sh

load_live_config "${DATADIR}/live.conf"

echo "Loaded ${DATADIR}/live.conf: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

livetimer=$(get_timer_ms)
CONSOLEFONT="$(kernel_cmdline vconsole.font)"
CONSOLEMAP="$(kernel_cmdline vconsole.font.map)"
arch=$(uname -m)
echo "Got consolefont and arch $arch: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

# Activate swap
livetimer=$(get_timer_ms)
configure_swap
echo "Activated swap and added to fstab: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

livetimer=$(get_timer_ms)
configure_language
echo "Languaged configured: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

livetimer=$(get_timer_ms)
locale-gen
echo "Ran locale-gen: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

livetimer=$(get_timer_ms)
configure_clock
echo "Configured cloack: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

livetimer=$(get_timer_ms)
configure_user
echo "Created user ${username} with password ${password}: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

livetimer=$(get_timer_ms)
configure_sudoers_d
echo "Configured sudoers: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

# Add BROWSER var in env and workaround for mate-terminal
livetimer=$(get_timer_ms)
configure_environment
echo "Configured env: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

livetimer=$(get_timer_ms)
configure_machine_id
echo "Configured machine-id: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

livetimer=$(get_timer_ms)
configure_accountsservice "${username}"
echo "Configured accountsservice: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

livetimer=$(get_timer_ms)
configure_displaymanager
echo "Configured displaymanager: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

livetimer=$(get_timer_ms)
configure_user_root /
echo "Configured root user: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

livetimer=$(get_timer_ms)
configure_alsa /
# Save settings
alsactl -f /etc/asound.state store &>/dev/null
echo "Configured alsa: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

configure_pamac

livetimer=$(get_timer_ms)
configure_samba
echo "Configured samba: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log

livetimer=$(get_timer_ms)
# load dm-mod
modprobe dm-mod
echo "Load dm-mod: $(elapsed_time_ms ${livetimer})ms" >> /var/log/manjaro-live.log
